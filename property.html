<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
  <title>Property Details ‚Äì Digital Realty</title>

  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #e7f2ed;
      color: #263238;
    }

    /* NAVBAR */
    .navbar {
      background: #1B5E20;
      padding: 18px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      font-size: 20px;
      font-weight: 600;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }

    .property-layout {
      display: flex;
      gap: 40px;
      padding: 40px 60px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    /* LEFT SIDE - GALLERY */
    .property-left {
      flex: 1.1;
    }

    .prop-main-img {
      width: 100%;
      height: 420px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 4px 18px rgba(0,0,0,0.1);
    }

    .thumbnail-row {
      display: flex;
      gap: 12px;
      margin-top: 18px;
    }

    .thumbnail {
      width: 90px;
      height: 70px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: 0.2s;
    }
    .thumbnail:hover {
      border-color: #1B5E20;
    }

    /* MAP BUTTON */
    .map-btn {
      display: block;
      background: #1B5E20;
      padding: 14px;
      text-align: center;
      color: white;
      margin-top: 25px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }

    /* RIGHT SIDE */
    .property-right {
      flex: 0.9;
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.12);
    }

    .property-right h1 {
      margin: 0;
      font-size: 32px;
      color: #1B5E20;
    }

    .property-right p {
      margin: 6px 0;
      color: #455A64;
      font-size: 16px;
    }

    .property-info-grid {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .info-item h4 {
      margin: 0;
      font-size: 14px;
      color: #1B5E20;
    }

    .info-item p {
      margin: 2px 0 0;
      font-weight: 600;
      color: #263238;
    }

    /* BUTTON ROW */
    .button-row {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }

    .action-btn {
      background: #1B5E20;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: 0.2s;
      text-decoration: none;
    }

    .action-btn:hover {
      background: #174d1b;
    }

    .availability-btn {
      background: #245f3a;
    }

    /* AGENT CARD */
    .agent-card {
      background: #f4faf5;
      padding: 18px;
      border-radius: 12px;
      margin-top: 30px;
      border-left: 6px solid #1B5E20;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .agent-info h3 {
      margin: 0 0 6px;
      font-size: 20px;
      color: #1B5E20;
    }

    .agent-info p {
      margin: 3px 0;
      color: #455A64;
      font-size: 15px;
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.4);
      max-width: 90vw;      /* allow big image */
      max-height: 90vh;
    }

    .availability-img {
     max-width: 900px;     /* about 2x larger */
     max-height: 80vh;     /* prevent overflow */
     width: 100%;
     height: auto;
     border-radius: 12px;
    }

    .close {
      cursor: pointer;
      float: right;
      font-size: 20px;
      margin-bottom: 10px;
      color: #1B5E20;
    }

    @media (max-width: 900px) {
      .property-layout { flex-direction: column; }
      .prop-main-img { height: 300px; }
    }
    #chatFab {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: #1B5E20;
  color: white;
  width: 58px;
  height: 58px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 26px;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
  z-index: 3000;
}

#chatBox {
  position: fixed;
  bottom: 95px;
  right: 25px;
  width: 320px;
  height: 420px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 22px rgba(0,0,0,0.3);
  display: none;
  flex-direction: column;
  z-index: 3000;
}

.chat-header {
  background: #1B5E20;
  color: white;
  padding: 12px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
}

.chat-body {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  background: #f1f8f4;
}

.chat-msg {
  padding: 8px 12px;
  margin-bottom: 8px;
  border-radius: 12px;
  font-size: 14px;
  max-width: 80%;
}

/* SENT message (your message) */
.chat-msg.client {
  background: #1B5E20; /* GREEN */
  color: #ffffff;
  margin-left: auto;
  text-align: right;
}

/* RECEIVED message (reply) */
.chat-msg.agent {
  background: #e0e0e0; /* GRAY */
  color: #263238;
  margin-right: auto;
  text-align: left;
}




.chat-input {
  display: flex;
  padding: 10px;
  border-top: 1px solid #ddd;
}

.chat-input input {
  flex: 1;
  border: none;
  outline: none;
}

.chat-input button {
  background: #1B5E20;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
}

  </style>

  <script src="/assets/js/session.js"></script>
</head>

<body>

<header class="navbar">
  Blessed R&C Development Corporation
  <div class="nav-right" id="navButtons"></div>
</header>

<section class="property-layout">
  <div class="property-left">
    <img id="mainImage" class="prop-main-img">
    <div id="thumbnailRow" class="thumbnail-row"></div>
    <a id="googleMapLink" target="_blank" class="map-btn">üìç Open Location in Google Maps</a>
  </div>

  <div class="property-right">
    <h1 id="propTitle"></h1>
    <p id="propLocation"></p>
    <p id="propPrice"></p>

    <div class="property-info-grid">
      <div class="info-item"><h4>Lot Area</h4><p id="infoArea"></p></div>
      <div class="info-item"><h4>Status</h4><p id="infoStatus"></p></div>
      <div class="info-item"><h4>Type</h4><p id="infoType"></p></div>
      <div class="info-item"><h4>Phase</h4><p id="infoPhase"></p></div>
    </div>

    <p id="propDescription" style="margin-top:18px;"></p>

    <!-- BUTTON ROW with NEW TAB CALCULATOR -->
    <div class="button-row">
      <a id="vrTourBtn" class="action-btn" target="_blank">VR Tour</a>
      <button id="bookBtn" class="action-btn">Book Appointment</button>
      <button onclick="openAvailability()" class="action-btn availability-btn">Availability</button>

              <a
        id="computeBtn"
        class="action-btn"
        target="_blank"
        style="background:#2E7D32;"
      >
        Compute Payment
      </a>

    </div>

    <div class="agent-card">
      <div class="agent-info">
        <h3 id="agentName"></h3>
        <p id="agentPhone"></p>
        <p id="agentEmail"></p>
      </div>
    </div>
  </div>
</section>

<!-- AVAILABILITY MODAL -->
<div id="availabilityModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAvailability()">&times;</span>
    <img id="availabilityImage" class="availability-img">
  </div>
</div>

<script>
/* ================= ENV SWITCH ================= */
const isLocal =
  location.hostname === "localhost" ||
  location.hostname === "127.0.0.1";

const API_BASE = isLocal
  ? "http://localhost:5000/api"
  : "https://digital-realty-mg9y.onrender.com/api";

const FILE_BASE = isLocal
  ? "http://localhost:5000"
  : "https://digital-realty-mg9y.onrender.com";

/* ================= GLOBAL STATE ================= */
let currentPropertyId = null;
let currentAgentId = null;
let currentClientId = null;
let chatInterval = null;
let lastMessageCount = 0;

/* ================= MAIN LOAD ================= */
document.addEventListener("DOMContentLoaded", async () => {
  /* 1Ô∏è‚É£ GET PROPERTY ID (URL FIRST, storage fallback) */
  const params = new URLSearchParams(window.location.search);
  const urlId = params.get("id");
  const storedId = localStorage.getItem("viewPropertyId");

  const id = urlId || storedId;

  if (!id) {
    alert("No property selected.");
    window.location.href = "/properties.html";
    return;
  }

  currentPropertyId = id;

  // keep storage in sync
  localStorage.setItem("viewPropertyId", id);

  /* 2Ô∏è‚É£ USER SESSION */
  const user = Session.getUser();
  if (user && user.role === "client") {
    currentClientId = user.id;
  }

  try {
    /* 3Ô∏è‚É£ FETCH PROPERTY */
    console.log("Fetching property ID:", id);
    const res = await fetch(`${API_BASE}/properties/${id}`);

    if (res.status === 404) {
      alert("Property not found.");
      window.location.href = "/properties.html";
      return;
    }

    if (!res.ok) {
      throw new Error("Property API failed");
    }

    const json = await res.json();
    if (!json.success || !json.data) {
      throw new Error("Invalid property response");
    }

    const p = json.data;

    /* ================= COMPUTE BUTTON ================= */
    const computeBtn = document.getElementById("computeBtn");
    if (!p.price || Number(p.price) <= 0) {
      computeBtn.style.pointerEvents = "none";
      computeBtn.style.background = "#9E9E9E";
    } else {
      computeBtn.href =
        `/customer/calculator.html?price_per_sqm=${Number(p.price)}`;
    }

    /* ================= PROPERTY DETAILS ================= */
    document.getElementById("propTitle").textContent = p.title || "";
    document.getElementById("propLocation").textContent =
      "üìç " + (p.location || "");
    document.getElementById("propPrice").textContent =
      "‚Ç±" + Number(p.price || 0).toLocaleString();

    document.getElementById("infoArea").textContent =
      (p.lot_area || "0") + " sqm";
    document.getElementById("infoStatus").textContent = p.status || "";
    document.getElementById("infoType").textContent = p.type || "";
    document.getElementById("infoPhase").textContent = p.phase || "";
    document.getElementById("propDescription").textContent =
      p.description || "";

    /* ================= SOLD LOCK ================= */
    const bookBtn = document.getElementById("bookBtn");
    if (p.status && p.status.toLowerCase() === "sold") {
      bookBtn.disabled = true;
      bookBtn.style.background = "#9E9E9E";
      bookBtn.style.cursor = "not-allowed";
      bookBtn.textContent = "Sold";
    }

    /* ================= BOOK APPOINTMENT ================= */
    bookBtn.addEventListener("click", () => {
      const user = Session.getUser();

      if (!user || !Session.isLoggedIn() || user.role !== "client") {
        alert("Please log in first.");
        window.location.href = "/login.html";
        return;
      }

      localStorage.setItem("bookingPropertyId", currentPropertyId);
      localStorage.setItem("bookingAgentId", currentAgentId || "");

      window.location.href = "/customer/booking.html";
    });

    /* ================= IMAGES ================= */
    let images = [];
    if (Array.isArray(p.images)) images = p.images;
    else if (typeof p.images === "string") {
      try { images = JSON.parse(p.images); } catch {}
    }

    images = images.map(img =>
      img.startsWith("http") ? img : `${FILE_BASE}${img}`
    );

    if (!images.length) images = ["../assets/img/no-image.jpg"];

    const mainImage = document.getElementById("mainImage");
    mainImage.src = images[0];

    const thumbnailRow = document.getElementById("thumbnailRow");
    thumbnailRow.innerHTML = "";
    images.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      img.className = "thumbnail";
      img.onclick = () => (mainImage.src = src);
      thumbnailRow.appendChild(img);
    });

    /* ================= LINKS ================= */
    document.getElementById("vrTourBtn").href = p.virtual_tour || "#";
    document.getElementById("googleMapLink").href = p.google_map || "#";

    /* ================= AVAILABILITY ================= */
    if (p.availability_image) {
      document.getElementById("availabilityImage").src =
        p.availability_image.startsWith("http")
          ? p.availability_image
          : `${FILE_BASE}${p.availability_image}`;
    }

    /* ================= AGENT ================= */
    if (!p.agent) return;

    currentAgentId = p.agent;
    const agentRes = await fetch(`${API_BASE}/agents/${p.agent}`);
    const agentJson = await agentRes.json();

    if (agentJson.success && agentJson.data) {
      const a = agentJson.data;
      document.getElementById("agentName").textContent = a.full_name;
      document.getElementById("agentPhone").textContent =
        "üìû " + (a.contact || "");
      document.getElementById("agentEmail").textContent =
        "‚úâÔ∏è " + (a.email || "");
    }

    /* ================= CHAT ================= */
    if (currentClientId && currentAgentId) {
      document.getElementById("chatFab").style.display = "flex";
      clearInterval(chatInterval);
      chatInterval = setInterval(loadChat, 4000);
    }

  } catch (err) {
    console.error("PROPERTY LOAD ERROR:", err);
    alert("Unable to load property. Please try again.");
  }
});

/* ================= CHAT FUNCTIONS ================= */
function toggleChat() {
  const box = document.getElementById("chatBox");
  box.style.display = box.style.display === "flex" ? "none" : "flex";
}

async function loadChat() {
  if (!currentPropertyId || !currentAgentId || !currentClientId) return;

  const res = await fetch(
    `${API_BASE}/chat/${currentPropertyId}/${currentAgentId}/${currentClientId}`
  );
  const json = await res.json();
  if (!json.success) return;

  const chat = document.getElementById("chatMessages");

  if (json.data.length !== lastMessageCount) {
    chat.innerHTML = "";
    json.data.forEach(m => {
      const div = document.createElement("div");
      div.className =
        m.sender_role === "client"
          ? "chat-msg client"
          : "chat-msg agent";
      div.textContent = m.message;
      chat.appendChild(div);
    });
    chat.scrollTop = chat.scrollHeight;
    lastMessageCount = json.data.length;
  }
}

async function sendChatMessage() {
  const input = document.getElementById("chatInput");
  const message = input.value.trim();
  if (!message || !currentClientId || !currentAgentId) return;

  await fetch(`${API_BASE}/chat/send`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      property_id: currentPropertyId,
      agent_id: currentAgentId,
      client_id: currentClientId,
      message
    })
  });

  input.value = "";
  loadChat();
}

/* ================= MODAL ================= */
function openAvailability() {
  document.getElementById("availabilityModal").style.display = "flex";
}
function closeAvailability() {
  document.getElementById("availabilityModal").style.display = "none";
}
</script>


<!-- FLOATING CHAT BUTTON -->
<div id="chatFab" onclick="toggleChat()">üí¨</div>

<!-- CHAT BOX -->
<div id="chatBox">
  <div class="chat-header">
    <span id="chatAgentName">Chat with Agent</span>
    <span class="chat-close" onclick="toggleChat()">‚úï</span>
  </div>

  <div class="chat-body" id="chatMessages"></div>

  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="Type a message..." />
    <button onclick="sendChatMessage()">Send</button>
  </div>
</div>


</body>
</html>
