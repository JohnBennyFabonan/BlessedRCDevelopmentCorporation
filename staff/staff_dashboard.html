<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Dashboard â€“ Digital Realty</title>

  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ICONS -->
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
    rel="stylesheet"
  />

  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #eef5f0;
      display: flex;
      min-height: 100vh;
    }

    .layout {
      display: flex;
      width: 100%;
    }

    .sidebar {
      width: 240px;
      background: #0f4d20;
      padding: 30px 20px;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      box-shadow: 4px 0 12px rgba(0,0,0,0.15);
    }

    .sidebar-title {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 25px;
    }

    .side-link {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: 0.2s ease-in-out;
    }

    .side-link:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(5px);
    }

    .side-link.active {
      background: white;
      color: #1b5e20;
      font-weight: 600;
    }

    .main-content {
      margin-left: 270px;
      padding: 40px;
      width: calc(100% - 270px);
    }

    .page-title {
      font-size: 30px;
      font-weight: 700;
      color: #1b5e20;
      margin-bottom: 8px;
    }

    .page-subtitle {
      font-size: 15px;
      color: #5a6e61;
      margin-bottom: 35px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 25px;
    }

    .stat-card {
      padding: 25px;
      border-radius: 18px;
      color: white;
      box-shadow: 0 6px 14px rgba(0,0,0,0.18);
      position: relative;
      overflow: hidden;
      transition: 0.25s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 20px rgba(0,0,0,0.28);
    }

    .stat-icon {
      font-size: 42px;
      opacity: 0.25;
      position: absolute;
      right: 20px;
      top: 20px;
    }

    .stat-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 40px;
      font-weight: 800;
      margin-top: 15px;
    }

    .sold { background: linear-gradient(135deg, #8d6e63, #5d4037); }
    .properties { background: linear-gradient(135deg, #2e7d32, #1b5e20); }
    .available { background: linear-gradient(135deg, #0277bd, #01579b); }
    .pending { background: linear-gradient(135deg, #f9a825, #f57f17); }
    .approved { background: linear-gradient(135deg, #6a1b9a, #4a148c); }
  </style>
</head>

<body>
<div class="layout">

  <aside class="sidebar">
    <h2 class="sidebar-title">Staff Panel</h2>

    <a href="staff_dashboard.html" class="side-link active">
      <i class="ri-dashboard-fill"></i> Dashboard
    </a>

    <a href="staff_upload_property.html" class="side-link">
      <i class="ri-upload-cloud-fill"></i> Upload Property
    </a>

    <a href="staff_manage_properties.html" class="side-link">
      <i class="ri-building-4-fill"></i> Manage Properties
    </a>

    <a href="staff_appointments.html" class="side-link">
      <i class="ri-calendar-check-fill"></i> Appointments
    </a>

    <a href="staff_account_settings.html" class="side-link">
      <i class="ri-settings-3-fill"></i> Account Settings
    </a>

    <a href="#" onclick="Session.logout('staff_login.html')" class="side-link">
      <i class="ri-logout-box-r-fill"></i> Logout
    </a>
  </aside>

  <main class="main-content">
    <h2 class="page-title">Staff Dashboard</h2>
    <p class="page-subtitle">Quick overview of properties and appointments</p>

    <div class="dashboard-grid">
      <div class="stat-card properties">
        <i class="ri-home-8-line stat-icon"></i>
        <div class="stat-title">Total Properties</div>
        <div class="stat-value" id="totalProperties">0</div>
      </div>

      <div class="stat-card available">
        <i class="ri-checkbox-circle-fill stat-icon"></i>
        <div class="stat-title">Available Properties</div>
        <div class="stat-value" id="availableProperties">0</div>
      </div>

      <div class="stat-card sold">
        <i class="ri-price-tag-3-fill stat-icon"></i>
        <div class="stat-title">Sold Properties</div>
        <div class="stat-value" id="soldProperties">0</div>
      </div>


      <div class="stat-card pending">
        <i class="ri-time-fill stat-icon"></i>
        <div class="stat-title">Pending Appointments</div>
        <div class="stat-value" id="pendingAppointments">0</div>
      </div>

      <div class="stat-card approved">
        <i class="ri-calendar-event-fill stat-icon"></i>
        <div class="stat-title">Approved Appointments</div>
        <div class="stat-value" id="approvedAppointments">0</div>
      </div>
    </div>
  </main>
</div>

<!-- SECURITY -->
<script src="/assets/js/session.js"></script>
<script src="/assets/js/config.js"></script>

<script>
  if (!Session.requireRole("staff", "staff_login.html")) {
    throw "Unauthorized";
  }
</script>

 <div id="securityModal" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    z-index:9999;
    align-items:center;
    justify-content:center;
  ">
    <div style="
      background:#fff;
      padding:30px;
      border-radius:16px;
      width:90%;
      max-width:420px;
      text-align:center;
      box-shadow:0 20px 40px rgba(0,0,0,0.3);
    ">
      <h3 style="color:#1b5e20; margin-bottom:10px;">
        Session Expired
      </h3>
      <p style="color:#555; margin-bottom:25px;">
        Your session is no longer valid. Please log in again.
      </p>

      <button onclick="redirectToLogin()" style="
        padding:12px 24px;
        background:#1b5e20;
        color:white;
        border:none;
        border-radius:10px;
        font-size:15px;
        font-weight:600;
        cursor:pointer;
      ">
        Go to Login
      </button>
    </div>
  </div>

  <script>
  function showSecurityModal() {
    const modal = document.getElementById("securityModal");
    if (modal) modal.style.display = "flex";
  }

  function redirectToLogin() {
    Session.logout("staff_login.html");
  }

  // ================= REALTIME SESSION WATCHER =================
  setInterval(() => {
    const user = Session.getUser();
    const loggedIn = Session.isLoggedIn();

    if (!user || !loggedIn || user.role !== "staff") {
      showSecurityModal();
    }
  }, 1000);
</script>


<script>
  window.addEventListener("pageshow", function (event) {
    if (event.persisted) window.location.reload();
  });

  const API = `${API_CONFIG.BASE_URL}/api`;

  async function loadStaffDashboard() {
    try {
      /* ================= PROPERTIES ================= */
      const propRes = await fetch(`${API}/properties`);
      const propJson = await propRes.json();

     let totalProperties = 0;
let availableProperties = 0;
let soldProperties = 0;

if (propJson.success && Array.isArray(propJson.data)) {
  totalProperties = propJson.data.length;

  availableProperties = propJson.data.filter(
    p => p.status && p.status.toLowerCase() === "available"
  ).length;

  soldProperties = propJson.data.filter(
    p => p.status && p.status.toLowerCase() === "sold"
  ).length;
}

      /* ================= APPOINTMENTS ================= */
      const appRes = await fetch(`${API}/appointments`);
      const appJson = await appRes.json();

      let pendingAppointments = 0;
      let approvedAppointments = 0;

      if (appJson.success && Array.isArray(appJson.data)) {
        pendingAppointments = appJson.data.filter(
          a => a.status && a.status.toLowerCase() === "pending"
        ).length;

        approvedAppointments = appJson.data.filter(
          a => a.status && a.status.toLowerCase() === "approved"
        ).length;
      }

      /* ================= UPDATE UI ================= */
      document.getElementById("totalProperties").textContent =
        totalProperties;

      document.getElementById("availableProperties").textContent =
        availableProperties;

      document.getElementById("soldProperties").textContent =
        soldProperties;

      document.getElementById("pendingAppointments").textContent =
        pendingAppointments;

      document.getElementById("approvedAppointments").textContent =
        approvedAppointments;

    } catch (err) {
      console.error("Dashboard load error:", err);
      alert("Unable to load dashboard data.");
    }
  }

  document.addEventListener("DOMContentLoaded", loadStaffDashboard);
</script>



</body>
</html>
