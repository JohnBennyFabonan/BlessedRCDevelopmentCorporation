<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Edit Property â€“ Staff</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: #eef5f0;
}

.layout { display: flex; }

.sidebar {
  width: 240px;
  height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  background: #0f4d20;
  padding: 30px 20px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  color: white;
}

.sidebar-title {
  font-size: 22px;
  font-weight: 700;
  text-align: center;
}

.side-link {
  padding: 12px;
  border-radius: 10px;
  background: rgba(255,255,255,0.1);
  color: white;
  text-decoration: none;
  display: flex;
  gap: 10px;
}

.main-content {
  margin-left: 270px;
  padding: 40px;
  width: calc(100% - 270px);
}

.content-card {
  background: white;
  padding: 35px;
  border-radius: 18px;
  max-width: 900px;
}

.page-title {
  font-size: 30px;
  font-weight: 700;
  color: #1B5E20;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 18px;
}

.form-grid input,
.form-grid select,
.form-grid textarea {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

textarea { resize: none; height: 120px; }

label {
  font-weight: 600;
  color: #1B5E20;
}

.submit-btn {
  margin-top: 25px;
  width: 100%;
  background: #1B5E20;
  color: white;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="layout">

<aside class="sidebar">
  <h2 class="sidebar-title">Staff Panel</h2>
  <a href="staff_upload_property.html" class="side-link"><i class="ri-upload-cloud-fill"></i> Upload Property</a>
  <a href="staff_manage_properties.html" class="side-link"><i class="ri-building-fill"></i> Manage Properties</a>
  <a href="staff_appointments.html" class="side-link"><i class="ri-calendar-check-fill"></i> Appointments</a>
  <a href="#" onclick="logout()" class="side-link"><i class="ri-logout-box-r-fill"></i> Logout</a>
</aside>

<main class="main-content">
  <div class="content-card">
    <h2 class="page-title">Edit Property</h2>

    <form id="editForm" enctype="multipart/form-data">

      <!-- REQUIRED FOR BACKEND -->
      <input type="hidden" name="created_by" id="createdBy">

      <div class="form-grid">

        <div><label>Property Name</label><input name="title" required></div>
        <div><label>Location</label><input name="location" required></div>
        <div><label>Price</label><input type="number" name="price" required></div>
        <div><label>Lot Area</label><input type="number" name="lot_area" required></div>
        <div><label>Phase</label><input name="phase" required></div>

        <div>
          <label>Type</label>
          <select name="type">
            <option>Residential Lot</option>
            <option>Commercial Lot</option>
            <option>Corner Lot</option>
            <option>Inner Lot</option>
          </select>
        </div>

        <div>
          <label>Status</label>
          <select name="status">
            <option>Available</option>
            <option>Reserved</option>
            <option>Sold</option>
          </select>
        </div>

        <div>
          <label>Agent</label>
          <select id="agentSelect" name="agent"></select>
        </div>

        <div><label>VR Tour Link</label><input name="virtual_tour"></div>
        <div><label>Google Map Link</label><input name="google_map"></div>

        <div style="grid-column: span 2;">
          <label>Description</label>
          <textarea name="description"></textarea>
        </div>

        <div style="grid-column: span 2;">
          <label>Upload New Images</label>
          <input type="file" name="images" multiple>
        </div>

        <div style="grid-column: span 2;">
          <label>Replace Availability Map</label>
          <input type="file" name="availability_image">
        </div>

      </div>

      <button class="submit-btn">Save Changes</button>
    </form>
  </div>
</main>
</div>

<script>
const API = "http://localhost:5000/api";
const user = JSON.parse(localStorage.getItem("user"));
const loggedIn = localStorage.getItem("loggedIn");
const propertyId = localStorage.getItem("editPropertyId");

if (!user || loggedIn !== "true" || user.role !== "staff") {
  alert("Unauthorized");
  window.location.href = "staff_login.html";
}

document.getElementById("createdBy").value = user.id;

/* LOAD AGENTS */
async function loadAgents(selected) {
  const res = await fetch(`${API}/admin/agents`);
  const json = await res.json();
  const select = document.getElementById("agentSelect");

  select.innerHTML = `<option value="">-- Select Agent --</option>`;
  if (json.success) {
    json.data.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = a.full_name;
      select.appendChild(opt);
    });
  }
  if (selected) select.value = selected;
}

/* LOAD PROPERTY */
async function loadProperty() {
  const res = await fetch(`${API}/properties/${propertyId}`);
  const json = await res.json();
  if (!json.success) return alert("Failed to load property");

  const p = json.data;
  document.querySelector("input[name='title']").value = p.title;
  document.querySelector("input[name='location']").value = p.location;
  document.querySelector("input[name='price']").value = p.price;
  document.querySelector("input[name='lot_area']").value = p.lot_area;
  document.querySelector("input[name='phase']").value = p.phase;
  document.querySelector("select[name='type']").value = p.type;
  document.querySelector("select[name='status']").value = p.status;
  document.querySelector("textarea[name='description']").value = p.description;
  document.querySelector("input[name='virtual_tour']").value = p.virtual_tour || "";
  document.querySelector("input[name='google_map']").value = p.google_map || "";

  loadAgents(p.agent);
}

loadProperty();

/* SUBMIT UPDATE */
document.getElementById("editForm").addEventListener("submit", async e => {
  e.preventDefault();

  const formData = new FormData(e.target);

  const res = await fetch(`${API}/properties/${propertyId}`, {
    method: "PUT",
    body: formData
  });

  const json = await res.json();
  console.log(json);

  if (json.success) {
    alert("Property updated successfully!");
    window.location.href = "staff_manage_properties.html";
  } else {
    alert(json.error || "Update failed");
  }
});

function logout() {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

</body>
</html>
