<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agent Dashboard ‚Äì Digital Realty</title>
  <link rel="stylesheet" href="../assets/css/style.css">

  <style>
/* Modal Overlay */
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  backdrop-filter: blur(3px);
  background: rgba(0, 0, 0, 0.45);
  justify-content: center;
  align-items: center;
  padding: 20px;
}

/* Modal Box */
.modal-box {
  background: #ffffff;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  border-radius: 15px;
  padding: 25px;
  overflow-y: auto;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  position: relative;
}

/* Close Button */
.close-btn {
  position: absolute;
  right: 18px;
  top: 15px;
  font-size: 26px;
  cursor: pointer;
  color: #444;
}

.close-btn:hover { color: #0a5c45; }

.modal-item {
  background: #f7f7f7;
  padding: 15px;
  margin-bottom: 12px;
  border-radius: 12px;
  border-left: 5px solid #0a5c45;
}
  </style>
</head>

<body class="auth-body">

<script src="/assets/js/session.js"></script>

<header class="navbar">
  <div class="nav-left">
    <h2 style="margin:0; font-weight:700; color:#0a5c45;">Blessed R&C Development Corporation</h2>
  </div>

  <nav class="nav-right">
    <a href="agent_dashboard.html" class="nav-link">Dashboard</a>
    <a href="agent_account_settings.html" class="nav-link">Profile</a>
    <a href="#" class="nav-link" id="logoutLink">Logout</a>
  </nav>
</header>


<!-- MAIN DASHBOARD -->
<div class="dashboard-container">

  <h2 class="dashboard-title">
    Welcome, <span id="agentName"></span>!
  </h2>
  <p class="dashboard-subtitle">Here is your daily overview</p>

  <div class="stats-section">

    <div class="stats-card" onclick="showAllAppointments()">
      <div class="stats-icon">üìÖ</div>
      <h3 id="totalAppointments">0</h3>
      <p>Total Assigned Appointments</p>
    </div>

    <div class="stats-card" onclick="showUpcomingAppointments()">
      <div class="stats-icon">‚è≥</div>
      <h3 id="upcomingCount">0</h3>
      <p>Upcoming</p>
    </div>

    <div class="stats-card" onclick="showAssignedProperties()">
      <div class="stats-icon">üè°</div>
      <h3 id="totalProperties">0</h3>
      <p>Assigned Properties</p>
    </div>

  </div>

  <h3 class="section-title">Today's Appointments</h3>
  <div id="todayAppointments"></div>

</div>


<!-- MODALS -->
<div id="modalAll" class="modal">
  <div class="modal-box">
    <h2>All Assigned Appointments</h2>
    <span class="close-btn" onclick="closeModal('modalAll')">&times;</span>
    <div id="modalAllContent"></div>
  </div>
</div>

<div id="modalUpcoming" class="modal">
  <div class="modal-box">
    <h2>Upcoming Appointments</h2>
    <span class="close-btn" onclick="closeModal('modalUpcoming')">&times;</span>
    <div id="modalUpcomingContent"></div>
  </div>
</div>

<div id="modalProperties" class="modal">
  <div class="modal-box">
    <h2>Assigned Properties</h2>
    <span class="close-btn" onclick="closeModal('modalProperties')">&times;</span>
    <div id="modalPropertiesContent"></div>
  </div>
</div>


<script>
const API_BASE = "http://localhost:5000/api";

let assignedAppointments = [];
let assignedProperties = [];

// LOAD DASHBOARD
document.addEventListener("DOMContentLoaded", () => {

  if (!Session.requireRole("agent", "/agent/agent_login.html")) return;

  document.getElementById("logoutLink").addEventListener("click", () => {
    Session.logout("/login.html");
  });

  loadAgentDashboard();
});

// CLEAN RESPONSE HANDLER
async function cleanResponse(fetchResponse) {
  const raw = await fetchResponse.json();
  if (Array.isArray(raw)) return raw;
  if (raw.data && Array.isArray(raw.data)) return raw.data;
  return [];
}

// LOAD DASHBOARD
async function loadAgentDashboard() {

  const agent = Session.getUser();
  if (!agent) return;

  document.getElementById("agentName").textContent = agent.full_name;

  const today = new Date().toISOString().split("T")[0];
  const todayContainer = document.getElementById("todayAppointments");
  todayContainer.innerHTML = "Loading...";

  try {
    // LOAD PROPERTIES
    const propsFetch = await fetch(`${API_BASE}/agents/assigned/${agent.id}`);
    const propsJson = await cleanResponse(propsFetch);
    assignedProperties = propsJson;

    document.getElementById("totalProperties").textContent =
      assignedProperties.length;

    assignedAppointments = [];

    // LOAD APPOINTMENTS FOR EACH PROPERTY
    for (const property of assignedProperties) {

      const apFetch = await fetch(`${API_BASE}/appointments/property/${property.id}`);
      const apJson = await cleanResponse(apFetch);

      apJson.forEach(app => {
        assignedAppointments.push({
          ...app,

          // ‚úÖ FIXED ‚Äî Use backend value, not undefined property.title
          property_title: app.property_title
        });
      });
    }

    document.getElementById("totalAppointments").textContent =
      assignedAppointments.length;

    const upcoming = assignedAppointments.filter(a => a.date >= today);
    document.getElementById("upcomingCount").textContent = upcoming.length;

    loadTodayAppointments(today, todayContainer);

  } catch (err) {
    console.error(err);
    todayContainer.innerHTML = "<p style='color:red;'>Error loading data.</p>";
  }
}


// TODAY APPOINTMENTS
function loadTodayAppointments(today, container) {

  const list = assignedAppointments.filter(a => a.date === today);

  if (!list.length) {
    container.innerHTML = "<p>No appointments today.</p>";
    return;
  }

  container.innerHTML = "";

  list.sort((a, b) => a.time.localeCompare(b.time));

  list.forEach(app => {
    container.innerHTML += `
      <div class="appointment-card">
        <h3>${app.property_title}</h3>
        <p><strong>Time:</strong> ${app.time}</p>
        <p><strong>Client:</strong> ${app.full_name}</p>
        <p><strong>Contact:</strong> ${app.contact}</p>
        <p><strong>Status:</strong> ${app.status}</p>
      </div>`;
  });
}


// MODAL FUNCTIONS
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }


// ALL APPOINTMENTS MODAL
function showAllAppointments() {
  const box = document.getElementById("modalAllContent");
  box.innerHTML = "";

  if (!assignedAppointments.length) {
    box.innerHTML = "<p>No assigned appointments.</p>";
    openModal("modalAll");
    return;
  }

  const sorted = [...assignedAppointments]
    .sort((a, b) => a.date === b.date ? a.time.localeCompare(b.time) : a.date.localeCompare(b.date));

  sorted.forEach(app => {
    box.innerHTML += `
      <div class="modal-item">
        <strong>${app.property_title}</strong><br>
        üìÖ ${app.date} ‚Äî üïí ${app.time}<br>
        üë§ ${app.full_name} (${app.contact})<br>
        Status: ${app.status}
      </div>`;
  });

  openModal("modalAll");
}


// UPCOMING APPOINTMENTS MODAL
function showUpcomingAppointments() {
  const box = document.getElementById("modalUpcomingContent");
  box.innerHTML = "";

  const today = new Date().toISOString().split("T")[0];
  const upcoming = assignedAppointments.filter(a => a.date >= today);

  if (!upcoming.length) {
    box.innerHTML = "<p>No upcoming appointments.</p>";
    openModal("modalUpcoming");
    return;
  }

  upcoming.forEach(app => {
    box.innerHTML += `
      <div class="modal-item">
        <strong>${app.property_title}</strong><br>
        üìÖ ${app.date} ‚Äî üïí ${app.time}<br>
        üë§ ${app.full_name} (${app.contact})<br>
        Status: ${app.status}
      </div>`;
  });

  openModal("modalUpcoming");
}


// ASSIGNED PROPERTIES
function showAssignedProperties() {
  const box = document.getElementById("modalPropertiesContent");
  box.innerHTML = "";

  if (!assignedProperties.length) {
    box.innerHTML = "<p>No assigned properties.</p>";
    openModal("modalProperties");
    return;
  }

  assignedProperties.forEach(p => {
    box.innerHTML += `
      <div class="modal-item">üè° ${p.title}</div>`;
  });

  openModal("modalProperties");
}

</script>

</body>
</html>
