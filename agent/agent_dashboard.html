<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Dashboard ‚Äì Digital Realty</title>

  <!-- STYLES -->
  <link rel="stylesheet" href="../assets/css/style.css" />
  <link rel="stylesheet" href="/assets/css/main.css" />

  <!-- CONFIG -->
  <script src="/assets/js/config.js"></script>

  <style>
    /* ===============================
       GLOBAL RESET
    ================================ */
    * {
      box-sizing: border-box;
    }

    /* ===============================
       NAVBAR
    ================================ */
    .navbar {
  position: fixed;        /* üî• key fix */
  top: 0;
  left: 0;
  width: 100vw;           /* full screen width */
  height: 70px;

  display: flex;
  align-items: center;
  justify-content: space-between;

  padding: 0 40px;
  background: #1b5e20;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  z-index: 2000;
}


    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
    }

    .nav-logo {
      height: 45px;
      width: auto;
    }

    .nav-right {
      display: flex;
      gap: 12px;
    }

    .nav-link {
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .nav-link:hover {
      background: rgba(255,255,255,0.15);
    }

    /* ===============================
       MODALS
    ================================ */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(3px);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-box {
      background: #ffffff;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      padding: 25px;
      border-radius: 15px;
      overflow-y: auto;
      position: relative;
    }

    .close-btn {
      position: absolute;
      right: 18px;
      top: 15px;
      font-size: 26px;
      cursor: pointer;
    }

    .modal-item {
      background: #f7f7f7;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 12px;
      border-left: 5px solid #0a5c45;
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .nav-right {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* ===== FORCE NAVBAR VISIBILITY ===== */
.navbar .nav-link {
  color: #ffffff !important;
  font-weight: 600;
  opacity: 1 !important;
  display: inline-block;
}

.navbar .nav-link:hover {
  background: rgba(255, 255, 255, 0.2);
  color: #ffffff;
}

  </style>
</head>

<body class="auth-body">

  <!-- SESSION -->
  <script src="/assets/js/session.js"></script>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="logo">
      <img
        src="/assets/img/LOGO-removebg-preview.png"
        class="nav-logo"
        alt="Logo"
      />
      <span>Blessed R&C Development Corporation</span>
    </div>

    <div class="nav-right">
  <a href="agent_dashboard.html" class="nav-link">Dashboard</a>

  <!-- NEW MESSAGES BUTTON -->
  <a href="agent_chat.html" class="nav-link">
    üí¨ Messages
  </a>

  <a href="agent_account_settings.html" class="nav-link">Account Setting</a>
  <a href="#" id="logoutLink" class="nav-link">Logout</a>
</div>
  </nav>

  <!-- MAIN DASHBOARD -->
  <div class="dashboard-container">
    <h2 class="dashboard-title">
      Welcome, <span id="agentName"></span>!
    </h2>
    <p class="dashboard-subtitle">Here is your daily overview</p>

    <div class="stats-section">
      <div class="stats-card" onclick="showAllAppointments()">
        <div class="stats-icon">üìÖ</div>
        <h3 id="totalAppointments">0</h3>
        <p>Total Assigned Appointments</p>
      </div>

      <div class="stats-card" onclick="showUpcomingAppointments()">
        <div class="stats-icon">‚è≥</div>
        <h3 id="upcomingCount">0</h3>
        <p>Upcoming</p>
      </div>

      <div class="stats-card" onclick="showAssignedProperties()">
        <div class="stats-icon">üè°</div>
        <h3 id="totalProperties">0</h3>
        <p>Assigned Properties</p>
      </div>
    </div>

    <h3 class="section-title">Today's Appointments</h3>
    <div id="todayAppointments"></div>
  </div>

  <!-- MODALS -->
  <div id="modalAll" class="modal">
    <div class="modal-box">
      <span class="close-btn" onclick="closeModal('modalAll')">&times;</span>
      <h2>All Assigned Appointments</h2>
      <div id="modalAllContent"></div>
    </div>
  </div>

  <div id="modalUpcoming" class="modal">
    <div class="modal-box">
      <span class="close-btn" onclick="closeModal('modalUpcoming')">&times;</span>
      <h2>Upcoming Appointments</h2>
      <div id="modalUpcomingContent"></div>
    </div>
  </div>

  <div id="modalProperties" class="modal">
    <div class="modal-box">
      <span class="close-btn" onclick="closeModal('modalProperties')">&times;</span>
      <h2>Assigned Properties</h2>
      <div id="modalPropertiesContent"></div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
  const API_BASE = `${API_CONFIG.BASE_URL}/api`;
  let assignedAppointments = [];
  let assignedProperties = [];

  document.addEventListener("DOMContentLoaded", () => {
    if (!Session.requireRole("agent", "/agent/agent_login.html")) return;

    document.getElementById("logoutLink").addEventListener("click", () => {
      Session.logout("/login.html");
    });

    loadAgentDashboard();
  });

  async function cleanResponse(res) {
    const json = await res.json();
    return Array.isArray(json) ? json : json.data || [];
  }

  async function loadAgentDashboard() {
    const agent = Session.getUser();
    document.getElementById("agentName").textContent = agent.full_name;

    const today = new Date().toISOString().split("T")[0];
    const todayContainer = document.getElementById("todayAppointments");
    todayContainer.innerHTML = "Loading...";

    try {
      /* ===============================
         LOAD PROPERTIES (AGENT + ADMIN)
      =============================== */

      // 1Ô∏è‚É£ Agent-assigned properties
      let agentProperties = [];
      const agentRes = await fetch(`${API_BASE}/agents/assigned/${agent.id}`);
      if (agentRes.ok) {
        agentProperties = await cleanResponse(agentRes);
      }

      // 2Ô∏è‚É£ Admin-uploaded properties (global)
      let adminProperties = [];
      const adminRes = await fetch(`${API_BASE}/properties`);
      if (adminRes.ok) {
        adminProperties = await cleanResponse(adminRes);
      }

      // 3Ô∏è‚É£ Merge without duplicates
      const propertyMap = new Map();
      [...agentProperties, ...adminProperties].forEach(p => {
        propertyMap.set(p.id, p);
      });

      assignedProperties = Array.from(propertyMap.values());
      document.getElementById("totalProperties").textContent =
        assignedProperties.length;

      /* ===============================
         LOAD APPOINTMENTS
      =============================== */

      assignedAppointments = [];

      for (const p of assignedProperties) {
        const apRes = await fetch(`${API_BASE}/appointments/property/${p.id}`);
        if (!apRes.ok) continue;

        const appts = await cleanResponse(apRes);
        appts
          .filter(a => a.status?.toLowerCase() !== "declined")
          .forEach(a => assignedAppointments.push(a));
      }

      document.getElementById("totalAppointments").textContent =
        assignedAppointments.length;

      document.getElementById("upcomingCount").textContent =
        assignedAppointments.filter(a => a.date >= today).length;

      loadTodayAppointments(today, todayContainer);

    } catch (err) {
      console.error(err);
      todayContainer.innerHTML =
        "<p style='color:red'>Failed to load data.</p>";
    }
  }

  function loadTodayAppointments(today, container) {
    const list = assignedAppointments.filter(a => a.date === today);

    if (!list.length) {
      container.innerHTML = "<p>No appointments today.</p>";
      return;
    }

    container.innerHTML = "";
    list.sort((a, b) => a.time.localeCompare(b.time));

    list.forEach(app => {
      container.innerHTML += `
        <div class="appointment-card">
          <h3>${app.property_title}</h3>
          <p><strong>Time:</strong> ${app.time}</p>
          <p><strong>Client:</strong> ${app.full_name}</p>
          <p><strong>Contact:</strong> ${app.contact}</p>
          <p><strong>Status:</strong> ${app.status}</p>
        </div>`;
    });
  }

  function openModal(id) {
    document.getElementById(id).style.display = "flex";
  }

  function closeModal(id) {
    document.getElementById(id).style.display = "none";
  }

  function showAllAppointments() {
    const box = document.getElementById("modalAllContent");
    box.innerHTML = assignedAppointments.map(a => `
      <div class="modal-item">
        <strong>${a.property_title}</strong><br>
        üìÖ ${a.date} üïí ${a.time}<br>
        üë§ ${a.full_name} (${a.contact})
      </div>`).join("");
    openModal("modalAll");
  }

  function showUpcomingAppointments() {
    const today = new Date().toISOString().split("T")[0];
    const box = document.getElementById("modalUpcomingContent");

    box.innerHTML = assignedAppointments
      .filter(a => a.date >= today)
      .map(a => `
        <div class="modal-item">
          <strong>${a.property_title}</strong><br>
          üìÖ ${a.date} üïí ${a.time}
        </div>`).join("");

    openModal("modalUpcoming");
  }

  function showAssignedProperties() {
    const box = document.getElementById("modalPropertiesContent");
    box.innerHTML = assignedProperties.map(p =>
      `<div class="modal-item">üè° ${p.title}</div>`
    ).join("");
    openModal("modalProperties");
  }
</script>


</body>
</html>
