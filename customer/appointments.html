 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Appointments ‚Äì Digital Realty</title>

  <script src="/assets/js/config.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: #e7f2ed;
      display: flex;
      min-height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: 230px;
      background: #1b5e20;
      padding: 30px 20px;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 22px;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
    }

    .sidebar h2 {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 15px;
    }

    .side-link {
      background: rgba(255,255,255,0.15);
      padding: 12px 14px;
      border-radius: 10px;
      color: white;
      text-decoration: none;
      transition: 0.2s;
      display: block;
    }

    .side-link:hover {
      background: rgba(255,255,255,0.25);
      transform: translateX(4px);
    }

    .side-link.active {
      background: white;
      color: #1b5e20;
      font-weight: 600;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 40px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #1b5e20;
    }

    .page-subtitle {
      color: #546e7a;
      font-size: 14px;
      margin-bottom: 30px;
    }

    /* APPOINTMENT CARD */
    .appointment-card {
      background: white;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      margin-bottom: 22px;
      border-left: 6px solid #1b5e20;
    }

    .appointment-card h3 {
      margin: 0 0 10px;
      color: #1b5e20;
    }

    .appointment-card p {
      margin: 4px 0;
      font-size: 14px;
    }

    .badge {
      float: right;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      color: white;
      font-weight: 600;
    }

    .approved { background: #2e7d32; }
    .pending { background: #fbc02d; }
    .canceled { background: #d9534f; }

    .btn-row {
      margin-top: 14px;
      display: flex;
      gap: 10px;
    }

    .edit-btn, .cancel-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .edit-btn { background: #1b5e20; color: white; }
    .cancel-btn { background: #d9534f; color: white; }

    /* EDIT MODAL */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 14px;
      width: 350px;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    /* CONFIRM MODAL */
    .confirm-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      justify-content: center;
      align-items: center;
      z-index: 1100;
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #1b5e20;
      color: white;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      transition: 0.3s;
      z-index: 1200;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.error {
      background: #d9534f;
    }
  </style>
</head>

<body>

<script src="/assets/js/session.js"></script>

<!-- SIDEBAR -->
<aside class="sidebar">
  <h2>Blessed R&C Development Corporation</h2>
  <a href="../index.html" class="side-link">üè° View Properties</a>
  <a href="customer_dashboard.html" class="side-link">üìä Dashboard</a>
  <a href="appointments.html" class="side-link active">üìÖ My Appointments</a>
  <a href="account_settings.html" class="side-link">‚öôÔ∏è Account Settings</a>
  <a href="#" class="side-link" onclick="Session.logout('/login.html')">üö™ Logout</a>
</aside>

<!-- MAIN -->
<div class="main-content">
  <h2 class="page-title">My Appointments</h2>
  <p class="page-subtitle">Your scheduled lot viewing appointments</p>
  <div id="appointmentsList">Loading appointments...</div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>Edit Appointment</h3>
    <input type="date" id="editDate">
    <input type="time" id="editTime">
    <textarea id="editMessage" rows="3"></textarea>
    <div class="btn-row">
      <button class="edit-btn" onclick="saveEdit()">Save</button>
      <button class="cancel-btn" onclick="closeEditModal()">Close</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal" class="confirm-modal">
  <div class="modal-content">
    <h3>Confirm Action</h3>
    <p id="confirmText"></p>
    <div class="btn-row" style="justify-content:flex-end">
      <button class="edit-btn" id="confirmYes">Yes</button>
      <button class="cancel-btn" id="confirmNo">Cancel</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<script>
  if (!Session.requireRole("client", "/login.html")) throw "redirect";

  const user = Session.getUser();
  const API = `${API_CONFIG.BASE_URL}/api`;
  let editingId = null;

  function showToast(msg, error=false) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.className = `toast show ${error ? "error" : ""}`;
    setTimeout(() => t.classList.remove("show"), 3000);
  }

  function showConfirm(msg, yes) {
    const m = document.getElementById("confirmModal");
    document.getElementById("confirmText").textContent = msg;
    m.style.display = "flex";
    document.getElementById("confirmYes").onclick = () => { m.style.display="none"; yes(); };
    document.getElementById("confirmNo").onclick = () => m.style.display="none";
  }

  (async function load() {
    const res = await fetch(`${API}/appointments/user/${user.id}`, {
      headers: { Authorization: `Bearer ${Session.getToken()}` }
    });
    const data = await res.json();
    const list = document.getElementById("appointmentsList");
    list.innerHTML = "";

    data.data.forEach(app => {
      const div = document.createElement("div");
      div.className = "appointment-card";
      div.innerHTML = `
        <span class="badge ${app.status.toLowerCase()}">${app.status}</span>
        <h3>${app.property_title}</h3>
        <p><b>Date:</b> ${app.date}</p>
        <p><b>Time:</b> ${app.time}</p>
        <p><b>Message:</b> ${app.message || "None"}</p>
        <div class="btn-row">
          <button class="edit-btn" onclick="openEditModal(${app.id},'${app.date}','${app.time}','${app.message||""}')">Edit</button>
          <button class="cancel-btn" onclick="cancelAppointment(${app.id},this)">Cancel</button>
        </div>`;
      list.appendChild(div);
    });
  })();

  function openEditModal(id,d,t,m){
    editingId=id;
    editDate.value=d; editTime.value=t; editMessage.value=m;
    editModal.style.display="flex";
  }

  function closeEditModal(){ editModal.style.display="none"; }

  async function saveEdit(){
    try{
      const res = await fetch(`${API}/appointments/${editingId}`,{
        method:"PUT",
        headers:{
          "Content-Type":"application/json",
          Authorization:`Bearer ${Session.getToken()}`
        },
        body:JSON.stringify({
          date:editDate.value,
          time:editTime.value,
          message:editMessage.value
        })
      });
      if(!res.ok) throw 0;
      showToast("Appointment updated");
      closeEditModal();
      setTimeout(()=>location.reload(),800);
    }catch{
      showToast("Update failed",true);
    }
  }

  function cancelAppointment(id,btn){
    showConfirm("Cancel this appointment?", async()=>{
      try{
        const res = await fetch(`${API}/appointments/${id}`,{
          method:"DELETE",
          headers:{Authorization:`Bearer ${Session.getToken()}`}
        });
        if(!res.ok) throw 0;
        showToast("Appointment canceled");
        btn.closest(".appointment-card").remove();
      }catch{
        showToast("Cancel failed",true);
      }
    });
  }
</script>

</body>
</html>
